name: Salesforce Build Pipeline - InterarchQA

on:
  push:
    branches:
      - build/QA
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  salesforce-deploy:
    runs-on: ubuntu-latest
    environment: QA

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node.js
      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Salesforce CLI & Plugins
      - name: üõ†Ô∏è Install Salesforce CLI and Plugins
        shell: bash
        run: |
          echo 'Installing sf CLI'
          npm install -g @salesforce/cli@latest
          echo 'Installing sfdx-git-delta'
          echo y | sfdx plugins:install sfdx-git-delta

      # 4Ô∏è‚É£ Authenticate to Salesforce
      - name: üîê Authenticate with Salesforce (JWT Auth)
        shell: bash
        run: |
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file asset/server.key \
            --username ${{ secrets.USER_NAME }} \
            --instance-url https://login.salesforce.com \
            --set-default

      # 5Ô∏è‚É£ Get Last Successful Commit ID
      - name: Get Last Successful Commit ID
        id: get-commit
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = `${{ github.event_name }}` === 'pull_request' ? `${{ github.event.pull_request.base.ref }}` : `${{ github.ref_name }}`;
            console.log(`branchName : ${branchName}`)
            const response = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: branchName,
              status: 'success',
              per_page: 1
            });

            if (response.data.workflow_runs.length > 0) {
              const lastSuccessfulCommitId = response.data.workflow_runs[0].head_sha;
              console.log(`Last successful commit ID: ${lastSuccessfulCommitId}`);
              return lastSuccessfulCommitId;
            } else {
              console.log('No successful runs found, using previous commit.');
              const exec = require('child_process').execSync;
              const previousCommitId = exec('git rev-parse HEAD^', { encoding: 'utf8' }).trim();
              console.log(`Previous commit ID: ${previousCommitId}`);
              return previousCommitId;
            }
          result-encoding: string 

      # 6Ô∏è‚É£ Store Last Commit ID
      - name: Store Last Commit ID
        run: echo "PREV_COMMIT_ID=${{ steps.get-commit.outputs.result }}" >> $GITHUB_ENV

       # 7Ô∏è‚É£ Generate SFDX Git Delta (with LWC support)
      - name: Generate SFDX Git Delta
        id: deltaChanges
        shell: pwsh
        run: |
          $prevCommitId = "$env:PREV_COMMIT_ID"
          Write-Host "Previous Commit ID : $prevCommitId"
          mkdir delta
          
          # Generate delta including LightningComponentBundle
          sfdx sgd:source:delta --from $prevCommitId --to HEAD --output delta/ --generate-delta --metadata "LightningComponentBundle"
          
          # Show what files were detected
          Write-Host "Files detected in delta/src:"
          if (Test-Path -Path "delta/src") {
            Get-ChildItem -Recurse delta/src
            $isChangesFound = $true
          } else {
            Write-Host "‚ö° No delta files detected"
            $isChangesFound = $false
          }

          $isChangesFoundStr = $isChangesFound.ToString().ToLower()
          echo "isCodeChanges=$isChangesFoundStr" >> $env:GITHUB_OUTPUT

      # 8Ô∏è‚É£ Upload Delta as Artifact (for debugging + visibility)
      - name: Upload Delta as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: salesforce-build-artifacts
          path: |
            delta/**
            Assets/**
            pipeline_scripts/**
            sfdx-project.json

      - name: Detect LWC Changes
        id: lwcChanges
        run: |
          echo "Checking for LWC changes..."
          git diff --name-only ${{ env.PREV_COMMIT_ID }} HEAD | grep "force-app/main/default/lwc" || true > lwc_changes.txt
          if [ -s lwc_changes.txt ]; then
            echo "‚úÖ LWC changes found"
            echo "isLwcChanges=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No LWC changes found"
            echo "isLwcChanges=false" >> $GITHUB_OUTPUT
          fi


      # 9Ô∏è‚É£ Deploy Changes (Delta or fallback to LWC folder)
      - name: üöÄ Deploy to Salesforce
        shell: bash
        run: |
          TARGET_USERNAME="${{ secrets.USER_NAME }}"
          
          if [ -f delta/package/package.xml ]; then
            echo "üì¶ Deploying delta package..."
            sf project deploy start --manifest delta/package/package.xml --target-org $TARGET_USERNAME --wait 10 --verbose
          elif [ "${{ steps.lwcChanges.outputs.isLwcChanges }}" == "true" ]; then
            echo "‚ö° Delta empty but LWC changed, deploying full LWC folder..."
            sf project deploy start --source-path force-app/main/default/lwc --target-org $TARGET_USERNAME --wait 10 --verbose
          else
            echo "‚úÖ No deployable changes found"
          fi

