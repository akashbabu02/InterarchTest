name: Salesforce QA Pipeline

on:
  push:
    branches:
      - build/QA
  pull_request:
    branches: 
      - build/QA

permissions:
  contents: read

env:
  URL: https://login.salesforce.com

jobs:
  fortify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ Checkout Code 
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Salesforce CLI & Plugins
        shell: bash
        run: |
          npm install -g @salesforce/cli@latest
          echo y | sfdx plugins:install sfdx-git-delta
          sf plugins:install @salesforce/sfdx-scanner

      - name: Authenticate to QA Org (JWT)
        shell: bash
        run: |
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file asset/server.key \
            --username minuscule@admin.com \
            --instance-url ${{ env.URL }} \
            --set-default

      - name: Run Fortify on Demand Scan
        uses: microfocus/fortify-ast-scan@v1
        with:
          api-token: ${{ secrets.FORTIFY_SECRET_KEY }}
          project-name: ${{ secrets.FORTIFY_PROJECT_NAME }}
          scan-target: "./force-app/main/default"
          upload-results: true
