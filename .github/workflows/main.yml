name: Salesforce QA Pipeline with Fortify CLI

on:
  push:
    branches:
      - build/QA
  pull_request:
    branches:
      - build/QA

jobs:
  fortify-scan:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: â¬‡Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js (required for sf CLI)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      # Step 4: Authenticate to Salesforce Org using JWT
      - name: Authenticate to Salesforce Org
        run: |
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file asset/server.key \
            --username minuscule@admin.com \
            --instance-url https://login.salesforce.com \
            --set-default

      # Step 5: Install Fortify CLI (fcli)
      - name: Install Fortify CLI
        run: |
           curl -L -o fcli.tar.gz https://github.com/fortify/fcli/releases/download/v3.8.1/fcli-linux-x86_64.tar.gz tar -xzf fcli.tar.gz -C /usr/local/bin

      # Step 6: Configure fcli with Fortify on Demand trial credentials
      - name: Configure Fortify CLI
        run: |
          fcli config set \
            --url https://trial.fortify.com \
            --tenant ${{ secrets.FORTIFY_TENENT }} \
            --user ${{ secrets.USER_NAME }} \
            --password ${{ secrets.FORTIFY_PASSWORD }}

      # Step 7: Run Fortify scan
      - name: Run Fortify Scan
        run: |
          fcli fod scan \
            --application SalesforceQA \
            --version test \
            --source ./force-app/main/default/lwc \
            --wait \
            --export ./fortify_scan_report.fpr

      # Step 8: Confirm Scan Info
      - name: Confirm Scan Info
        run: |
          echo "Fortify Scan completed!"
          echo "Tenant: ${{ secrets.FORTIFY_TENENT }}"
          echo "Release: SalesforceQA:test"
          ls -lh ./fortify_scan_report.fpr

      # Step 9: Upload Fortify Scan Report as GitHub artifact
      - name: Upload Fortify Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: FortifyScanReport
          path: ./fortify_scan_report.fpr


