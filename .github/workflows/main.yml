name: Salesforce Build Pipeline - InterarchQA

on:
  push:
    branches:
      - build/QA
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  salesforce-deploy:
    runs-on: ubuntu-latest
    environment: QA

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Setup Node.js
      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install Salesforce CLI & Plugins
      - name: ðŸ› ï¸ Install Salesforce CLI and Plugins
        shell: bash
        run: |
          echo 'Installing sf CLI'
          npm install -g @salesforce/cli@latest
          echo 'Installing sfdx-git-delta'
          echo y | sfdx plugins:install sfdx-git-delta

      # 4ï¸âƒ£ Authenticate to Salesforce
      - name: ðŸ” Authenticate with Salesforce (JWT Auth)
        shell: bash
        run: |
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file asset/server.key \
            --username ${{ secrets.USER_NAME }} \
            --instance-url https://login.salesforce.com \
            --set-default

      # 5ï¸âƒ£ Get Last Successful Commit ID
      - name: Get Last Successful Commit ID
        id: get-commit
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = `${{ github.event_name }}` === 'pull_request' ? `${{ github.event.pull_request.base.ref }}` : `${{ github.ref_name }}`;
            console.log(`branchName : ${branchName}`)
            const response = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: branchName,
              status: 'success',
              per_page: 1
            });

            if (response.data.workflow_runs.length > 0) {
              const lastSuccessfulCommitId = response.data.workflow_runs[0].head_sha;
              console.log(`Last successful commit ID: ${lastSuccessfulCommitId}`);
              return lastSuccessfulCommitId;
            } else {
              console.log('No successful runs found, using previous commit.');
              const exec = require('child_process').execSync;
              const previousCommitId = exec('git rev-parse HEAD^', { encoding: 'utf8' }).trim();
              console.log(`Previous commit ID: ${previousCommitId}`);
              return previousCommitId;
            }
          result-encoding: string 

      # 6ï¸âƒ£ Store Last Commit ID
      - name: Store Last Commit ID
        run: echo "PREV_COMMIT_ID=${{ steps.get-commit.outputs.result }}" >> $GITHUB_ENV

       # 7ï¸âƒ£ Generate SFDX Git Delta (with LWC support)
      - name: Generate SFDX Git Delta
        id: deltaChanges
        shell: pwsh
        run: |
          $prevCommitId = "$env:PREV_COMMIT_ID"
          Write-Host "Previous Commit ID : $prevCommitId"
          mkdir delta
          
          # Generate delta including LightningComponentBundle
          sfdx sgd:source:delta --from $prevCommitId --to HEAD --output delta/ --generate-delta --metadata "LightningComponentBundle"
          
          # Show what files were detected
          Write-Host "Files detected in delta/src:"
          if (Test-Path -Path "delta/src") {
            Get-ChildItem -Recurse delta/src
            $isChangesFound = $true
          } else {
            Write-Host "âš¡ No delta files detected"
            $isChangesFound = $false
          }

          $isChangesFoundStr = $isChangesFound.ToString().ToLower()
          echo "isCodeChanges=$isChangesFoundStr" >> $env:GITHUB_OUTPUT

      # 8ï¸âƒ£ Upload Delta as Artifact (for debugging + visibility)
      - name: Upload Delta as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: salesforce-build-artifacts
          path: |
            delta/**
            Assets/**
            pipeline_scripts/**
            sfdx-project.json

      # 9ï¸âƒ£ Deploy Changes (Delta or fallback to LWC folder)
      - name: ðŸš€ Deploy to Salesforce
        shell: bash
        run: |
          TARGET_USERNAME="${{ secrets.USER_NAME }}"

          if [ -f delta/package/package.xml ]; then
            echo "ðŸ“¦ Deploying delta package to $TARGET_USERNAME ..."
            sf project deploy start --manifest delta/package/package.xml --target-org $TARGET_USERNAME --wait 10 --verbose
            sf project deploy report -r --json > deploymentOut.json
          else
            echo "âš¡ No delta package detected, deploying full LWC as fallback..."
            sf project deploy start --source-path force-app/main/default/lwc --target-org $TARGET_USERNAME --wait 10 --verbose
          fi
