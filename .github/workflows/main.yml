name: Salesforce QA Pipeline with Fortify

on:
  push:
    branches:
      - build/QA
  pull_request:
    branches:
      - build/QA

jobs:
  fortify-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli sfdx-cli

      - name: Authenticate to Salesforce Org
        run: |
          sfdx auth:jwt:grant \
            --clientid ${{ secrets.CONSUMER_KEY }} \
            --jwtkeyfile asset/server.key \
            --username minuscule@admin.com \
            --instanceurl https://login.salesforce.com \
            --setdefaultdevhubusername
      
      - name: Prepare Fortify Scan
        # This step uses a different action or command to prepare the scan artifact
        # For FoD, you would typically use ScanCentral Client. This is an example.
        run: |
          # This is a placeholder command for demonstration purposes
          echo "Preparing scan package for Fortify"
          # The actual command to create the package will vary
          # It would involve downloading and running ScanCentral Client
      
      - name: Fortify AST Scan
        uses: fortify/github-action@v2
        with:
          # `scan-target`, `application-name`, etc. are not direct inputs
          # The scan details are typically passed through environment variables
          sast-scan: true
        env:
          FOD_API: https://api.trial.fortify.com
          FOD_API_TOKEN: ${{ secrets.FORTIFY_SECRET_KEY }}
          FOD_USERNAME: ${{ secrets.FORTIFY_USERNAME }}           
          FOD_PASSWORD: ${{ secrets.FORTIFY_PASSWORD }}           
          FOD_TENANT: ${{ secrets.FORTIFY_TENANT }}
          FOD_APPVERSION: SalesforceQA:test # This is how to set the application and version
          SCAN_TARGET: ./force-app/main/default # This needs a different mechanism
          # A starter workflow often uses a file, or you use a manual package step
          
      - name: Upload Fortify Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: fortify-sast-report
          path: gh-fortify-sast.sarif

