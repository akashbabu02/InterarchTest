name: Salesforce QA Pipeline with Fortify

on:
  push:
    branches:
      - build/QA
  pull_request:
    branches:
      - build/QA

jobs:
  fortify-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate to Salesforce Org
        run: |
          sf auth jwt --clientid ${{ secrets.CONSUMER_KEY }} \
            --jwtkeyfile asset/server.key \
            --username minuscule@admin.com \
            --instanceurl https://login.salesforce.com \
            --setdefaultusername

      - name: Fortify AST Scan
        uses: fortify/github-action@v2.1.1
        with:
          sast-scan: true                    # Enable SAST scan
          debricked-sca-scan: false          # Disable SCA scan
          scan-target: ./force-app/main/default # Path to Salesforce code
          application-name: SalesforceQA
          version-name: test
          upload-results: true               # Upload results to FoD
        env:
          FOD_API: https://api.trial.fortify.com   # Use your trial API URL
          FOD_API_TOKEN: ${{ secrets.FORTIFY_SECRET_KEY }}

      - name: Upload Fortify Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: FortifyScanReport
          path: ./fortify_scan_report.fpr

